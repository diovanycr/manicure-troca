<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico - Estrutura do Banco</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 2rem;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #252526;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    h1 {
      color: #4ec9b0;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #4ec9b0;
      padding-bottom: 0.5rem;
    }
    h2 {
      color: #dcdcaa;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    .status {
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
      border-left: 4px solid #4ec9b0;
      background: #2d2d30;
    }
    .error {
      border-left-color: #f48771;
      background: #3d2929;
    }
    .success {
      border-left-color: #4ec9b0;
    }
    .warning {
      border-left-color: #dcdcaa;
      background: #3d3929;
    }
    .code {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      margin: 1rem 0;
      border: 1px solid #3e3e42;
    }
    .btn {
      background: #0e639c;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    .btn:hover {
      background: #1177bb;
    }
    .json-viewer {
      max-height: 500px;
      overflow-y: auto;
    }
    .loading {
      color: #4ec9b0;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagn√≥stico de Estrutura do Banco de Dados</h1>
    
    <div class="status" id="auth-status">
      <span class="loading">‚è≥ Aguardando autentica√ß√£o...</span>
    </div>

    <div id="actions" style="display: none;">
      <button class="btn" onclick="checkDatabaseStructure()">1. Verificar Estrutura Completa</button>
      <button class="btn" onclick="checkSpecificManicure()">2. Buscar Manicure Espec√≠fica</button>
      <button class="btn" onclick="listAllManicures()">3. Listar Todas as Manicures</button>
      <button class="btn" onclick="checkManicureId()">4. Verificar ID da URL</button>
    </div>

    <div id="results"></div>
  </div>

  <script type="module">
    import { auth } from '../config/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { database } from '../config/firebase-config.js';
    import { ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        const authStatus = document.getElementById('auth-status');
        authStatus.className = 'status success';
        authStatus.innerHTML = `
          <strong>‚úÖ Autenticado com sucesso</strong><br>
          Email: ${user.email}<br>
          UID: <code>${user.uid}</code>
        `;
        document.getElementById('actions').style.display = 'block';
      } else {
        const authStatus = document.getElementById('auth-status');
        authStatus.className = 'status error';
        authStatus.innerHTML = '‚ùå N√£o autenticado. Redirecionando para login...';
        setTimeout(() => {
          window.location.href = '../login.html';
        }, 2000);
      }
    });

    window.checkDatabaseStructure = async () => {
      const results = document.getElementById('results');
      results.innerHTML = '<div class="status"><span class="loading">üîÑ Verificando estrutura...</span></div>';

      try {
        // Verifica se existe o n√≥ users
        const usersRef = ref(database, 'users');
        const usersSnap = await get(usersRef);
        
        let html = '<h2>üìä Estrutura do Banco de Dados</h2>';
        
        if (!usersSnap.exists()) {
          html += '<div class="status error">‚ùå O n√≥ "users" n√£o existe no banco!</div>';
        } else {
          html += '<div class="status success">‚úÖ O n√≥ "users" existe</div>';
        }

        // Verifica se existe users/{uid}
        const userRef = ref(database, `users/${currentUser.uid}`);
        const userSnap = await get(userRef);
        
        if (!userSnap.exists()) {
          html += `<div class="status error">‚ùå O n√≥ "users/${currentUser.uid}" n√£o existe!</div>`;
          html += '<div class="status warning">‚ö†Ô∏è <strong>PROBLEMA ENCONTRADO:</strong> Seus dados est√£o sendo salvos sem o prefixo "users/{uid}"!</div>';
        } else {
          html += `<div class="status success">‚úÖ O n√≥ "users/${currentUser.uid}" existe</div>`;
        }

        // Verifica se existe users/{uid}/manicures
        const manicuresRef = ref(database, `users/${currentUser.uid}/manicures`);
        const manicuresSnap = await get(manicuresRef);
        
        if (!manicuresSnap.exists()) {
          html += `<div class="status error">‚ùå O n√≥ "users/${currentUser.uid}/manicures" n√£o existe!</div>`;
        } else {
          html += `<div class="status success">‚úÖ O n√≥ "users/${currentUser.uid}/manicures" existe</div>`;
          html += `<div class="code json-viewer"><pre>${JSON.stringify(manicuresSnap.val(), null, 2)}</pre></div>`;
        }

        // Verifica tamb√©m o n√≥ raiz 'manicures' (sem users)
        const rootManicuresRef = ref(database, 'manicures');
        const rootManicuresSnap = await get(rootManicuresRef);
        
        if (rootManicuresSnap.exists()) {
          html += '<h2>‚ö†Ô∏è ESTRUTURA ANTIGA ENCONTRADA</h2>';
          html += '<div class="status warning">Existe um n√≥ "manicures" na raiz do banco (estrutura antiga):</div>';
          html += `<div class="code json-viewer"><pre>${JSON.stringify(rootManicuresSnap.val(), null, 2)}</pre></div>`;
        }

        results.innerHTML = html;
      } catch (error) {
        results.innerHTML = `<div class="status error">‚ùå Erro: ${error.message}</div>`;
        console.error(error);
      }
    };

    window.checkSpecificManicure = async () => {
      const results = document.getElementById('results');
      
      // Pega o ID da URL se existir
      const urlParams = new URLSearchParams(window.location.search);
      const urlId = decodeURIComponent(urlParams.get('id') || '');
      
      const manicureId = prompt('Digite o ID da manicure:', urlId || '-Ok8TnuBNMoHTbE_l_NQ');
      if (!manicureId) return;

      results.innerHTML = '<div class="status"><span class="loading">üîÑ Buscando manicure...</span></div>';

      try {
        let html = `<h2>üîé Busca pela Manicure: ${manicureId}</h2>`;
        
        // Tenta no caminho correto (com users)
        const correctPath = `users/${currentUser.uid}/manicures/${manicureId}`;
        const correctRef = ref(database, correctPath);
        const correctSnap = await get(correctRef);
        
        html += `<h3>Caminho: users/{uid}/manicures/{id}</h3>`;
        html += `<div class="code">${correctPath}</div>`;
        
        if (correctSnap.exists()) {
          html += '<div class="status success">‚úÖ ENCONTRADA neste caminho!</div>';
          html += `<div class="code json-viewer"><pre>${JSON.stringify(correctSnap.val(), null, 2)}</pre></div>`;
        } else {
          html += '<div class="status error">‚ùå N√ÉO encontrada neste caminho</div>';
        }

        // Tenta no caminho antigo (sem users)
        const oldPath = `manicures/${manicureId}`;
        const oldRef = ref(database, oldPath);
        const oldSnap = await get(oldRef);
        
        html += `<h3>Caminho: manicures/{id} (estrutura antiga)</h3>`;
        html += `<div class="code">${oldPath}</div>`;
        
        if (oldSnap.exists()) {
          html += '<div class="status warning">‚ö†Ô∏è ENCONTRADA neste caminho (estrutura antiga)!</div>';
          html += `<div class="code json-viewer"><pre>${JSON.stringify(oldSnap.val(), null, 2)}</pre></div>`;
          html += '<div class="status warning"><strong>SOLU√á√ÉO:</strong> Seus dados est√£o na estrutura antiga. Voc√™ precisa migrar os dados ou ajustar o c√≥digo para usar a estrutura antiga.</div>';
        } else {
          html += '<div class="status">‚ùå N√ÉO encontrada neste caminho</div>';
        }

        results.innerHTML = html;
      } catch (error) {
        results.innerHTML = `<div class="status error">‚ùå Erro: ${error.message}</div>`;
        console.error(error);
      }
    };

    window.listAllManicures = async () => {
      const results = document.getElementById('results');
      results.innerHTML = '<div class="status"><span class="loading">üîÑ Listando manicures...</span></div>';

      try {
        let html = '<h2>üìã Todas as Manicures</h2>';
        
        // Lista do caminho novo
        const newRef = ref(database, `users/${currentUser.uid}/manicures`);
        const newSnap = await get(newRef);
        
        html += '<h3>users/{uid}/manicures:</h3>';
        if (newSnap.exists()) {
          const data = newSnap.val();
          const count = Object.keys(data).length;
          html += `<div class="status success">‚úÖ Encontradas ${count} manicures</div>`;
          html += '<div class="code json-viewer"><pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
        } else {
          html += '<div class="status">‚ùå Nenhuma manicure encontrada</div>';
        }

        // Lista do caminho antigo
        const oldRef = ref(database, 'manicures');
        const oldSnap = await get(oldRef);
        
        html += '<h3>manicures (estrutura antiga):</h3>';
        if (oldSnap.exists()) {
          const data = oldSnap.val();
          const count = Object.keys(data).length;
          html += `<div class="status warning">‚ö†Ô∏è Encontradas ${count} manicures na estrutura antiga</div>`;
          html += '<div class="code json-viewer"><pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
        } else {
          html += '<div class="status">‚ùå Nenhuma manicure encontrada</div>';
        }

        results.innerHTML = html;
      } catch (error) {
        results.innerHTML = `<div class="status error">‚ùå Erro: ${error.message}</div>`;
        console.error(error);
      }
    };

    window.checkManicureId = () => {
      const urlParams = new URLSearchParams(window.location.search);
      const rawId = urlParams.get('id');
      const decodedId = decodeURIComponent(rawId || '');

      const html = `
        <h2>üîç Informa√ß√µes do ID da URL</h2>
        <div class="status">
          <strong>ID Bruto (raw):</strong><br>
          <code>${rawId || 'Nenhum ID na URL'}</code>
        </div>
        <div class="status">
          <strong>ID Decodificado:</strong><br>
          <code>${decodedId || 'Nenhum ID na URL'}</code>
        </div>
        <div class="status">
          <strong>URL Completa:</strong><br>
          <code>${window.location.href}</code>
        </div>
      `;

      document.getElementById('results').innerHTML = html;
    };
  </script>
</body>
</html>
