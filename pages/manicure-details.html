<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Manicure - Gest√£o</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="data:,">
    <style>
        .container-page { max-width: 900px; margin: 0 auto; padding: 2rem; font-family: 'Inter', sans-serif; }
        .card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .header-flex { display: flex; justify-content: space-between; align-items: flex-start; }
        .badge { padding: 4px 12px; border-radius: 99px; font-size: 12px; font-weight: bold; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-inactive { background: #f1f5f9; color: #475569; }
        .info-label { font-size: 12px; color: #64748b; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .info-value { font-size: 16px; color: #1e293b; margin-bottom: 16px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
        .btn-primary { background: #7c3aed; color: white; }
        .btn-secondary { background: #e2e8f0; color: #475569; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 450px; }
    </style>
</head>
<body>

    <div class="container-page">
        <a href="../index.html" style="color: #7c3aed; text-decoration: none; font-weight: bold;">‚Üê Voltar para Lista</a>

        <div class="card" style="margin-top: 1rem;">
            <div class="header-flex">
                <div>
                    <h1 id="det-name">Carregando...</h1>
                    <p id="det-phone" style="color: #64748b;">--</p>
                    <span id="det-status" class="badge">---</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn btn-primary" id="btn-open-exchange">üîÑ Registrar Troca</button>
                    <button class="btn btn-secondary" id="btn-toggle-status">Ativar/Desativar</button>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="card">
                <h3>Dados Cadastrais</h3>
                <div class="info-label">Endere√ßo</div>
                <div class="info-value" id="det-address">--</div>
                <div class="info-label">Plano</div>
                <div class="info-value" id="det-plan">--</div>
            </div>

            <div class="card">
                <h3>Pr√≥xima Troca</h3>
                <div class="info-label">Data Estimada</div>
                <div class="info-value" id="det-next-date">--/--/----</div>
                <div class="info-label">Dias Restantes</div>
                <div class="info-value" id="det-days-left">--</div>
            </div>
        </div>

        <div class="card">
            <h3>Hist√≥rico de Trocas</h3>
            <div id="history-list">
                <p style="color: #94a3b8;">Nenhuma troca registrada.</p>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-exchange">
        <div class="modal-content">
            <h2>Confirmar Troca de Kit</h2>
            <p>Deseja registrar que o kit foi trocado hoje? O ciclo de 28 dias ser√° reiniciado.</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="btn-close-modal">Cancelar</button>
                <button class="btn btn-primary" id="btn-confirm-exchange">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { authManager } from '../js/auth.js';
        import { dbManager } from '../js/database.js';
        import { getDatabase, ref, get, update, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Prote√ß√£o de Rota
        authManager.requireAuth();

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        if (!id) window.location.href = '../index.html';

        async function loadPage() {
            try {
                const uid = await dbManager._waitForUser();
                const db = getDatabase();
                const snapshot = await get(ref(db, `users/${uid}/manicures/${id}`));

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    renderUI(data);
                    renderHistory(uid);
                }
            } catch (err) {
                console.error("Erro ao carregar:", err);
            }
        }

        function renderUI(data) {
            document.getElementById('det-name').textContent = data.name;
            document.getElementById('det-phone').textContent = data.phone;
            document.getElementById('det-address').textContent = data.address || 'N√£o informado';
            document.getElementById('det-plan').textContent = "Plano " + data.planType;
            
            const statusBadge = document.getElementById('det-status');
            const isActive = data.status === 'active';
            statusBadge.textContent = isActive ? 'ATIVA' : 'INATIVA';
            statusBadge.className = `badge ${isActive ? 'status-active' : 'status-inactive'}`;

            if (data.nextExchangeDate) {
                const next = new Date(data.nextExchangeDate);
                document.getElementById('det-next-date').textContent = next.toLocaleDateString();
                const diff = Math.ceil((next - new Date()) / (1000 * 60 * 60 * 24));
                document.getElementById('det-days-left').textContent = diff > 0 ? diff + " dias" : "Atrasado!";
            }
        }

        async function renderHistory(uid) {
            const db = getDatabase();
            const snap = await get(ref(db, `users/${uid}/exchanges/${id}`));
            const list = document.getElementById('history-list');
            if (snap.exists()) {
                list.innerHTML = Object.values(snap.val()).reverse().map(ex => `
                    <div style="padding: 10px 0; border-bottom: 1px solid #f1f5f9;">
                        <strong>üìÖ ${new Date(ex.date).toLocaleDateString()}</strong> - Kit trocado
                    </div>
                `).join('');
            }
        }

        // Eventos de Clique
        document.getElementById('btn-open-exchange').onclick = () => document.getElementById('modal-exchange').classList.add('show');
        document.getElementById('btn-close-modal').onclick = () => document.getElementById('modal-exchange').classList.remove('show');
        
        document.getElementById('btn-confirm-exchange').onclick = async () => {
            const uid = await dbManager._waitForUser();
            const db = getDatabase();
            const now = Date.now();
            const next = now + (28 * 24 * 60 * 60 * 1000);

            await push(ref(db, `users/${uid}/exchanges/${id}`), { date: now });
            await update(ref(db, `users/${uid}/manicures/${id}`), {
                lastExchangeDate: now,
                nextExchangeDate: next
            });

            location.reload();
        };

        document.getElementById('btn-toggle-status').onclick = async () => {
            const uid = await dbManager._waitForUser();
            const db = getDatabase();
            const statusBadge = document.getElementById('det-status');
            const newStatus = statusBadge.textContent === 'ATIVA' ? 'inactive' : 'active';
            
            await update(ref(db, `users/${uid}/manicures/${id}`), { status: newStatus });
            location.reload();
        };

        loadPage();
    </script>
</body>
</html>
