<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes da Manicure - Gest√£o de Manicures</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" href="data:,">
  <style>
    /* Estilos recuperados e organizados */
    .container-page { max-width: 900px; margin: 0 auto; padding: 2rem; }
    .header-card { background: white; padding: 2rem; border-radius: 1rem; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; margin-bottom: 2rem; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
    .card { background: white; border-radius: 0.75rem; border: 1px solid #e2e8f0; margin-bottom: 2rem; }
    .card-header { padding: 1.5rem; border-bottom: 1px solid #e2e8f0; font-weight: bold; }
    .card-body { padding: 1.5rem; }
    
    /* Toggle Status Style */
    .status-toggle { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; cursor: pointer; }
    .toggle-switch { width: 40px; height: 20px; background: #cbd5e1; border-radius: 20px; position: relative; transition: 0.3s; }
    .toggle-switch.active { background: #22c55e; }
    .toggle-switch::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
    .toggle-switch.active::after { left: 22px; }

    /* Modal Style */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; }
    
    .history-item { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
    .btn-group { display: flex; flex-direction: column; gap: 10px; }
  </style>
</head>
<body>

  <div class="container-page">
    <a href="../index.html" style="text-decoration: none; color: #7c3aed; font-weight: bold;">‚Üê Voltar</a>

    <div class="header-card">
      <div>
        <h1 id="det-name">Carregando...</h1>
        <p id="det-phone">--</p>
        <span id="det-status-badge" class="badge">---</span>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" id="open-exchange">üîÑ Registrar Troca</button>
        <button class="btn btn-secondary" id="open-upload">üìÇ Enviar Comprovante</button>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">Informa√ß√µes</div>
        <div class="card-body">
          <p><strong>Endere√ßo:</strong> <span id="det-address">--</span></p>
          <p><strong>Plano:</strong> <span id="det-plan">--</span></p>
          <div class="status-toggle" id="btn-toggle-status">
            <div class="toggle-switch" id="toggle-ui"></div>
            <span id="status-text">Ativa</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Ciclo de Troca</div>
        <div class="card-body">
          <p><strong>Pr√≥xima Troca:</strong> <span id="next-date">--/--/----</span></p>
          <p><strong>Dias restantes:</strong> <span id="days-left">--</span></p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Hist√≥rico de Trocas</div>
      <div class="card-body" id="history-list">
        <p style="color: #64748b;">Nenhuma troca registrada ainda.</p>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-exchange">
    <div class="modal-content">
      <h2>Registrar Nova Troca</h2>
      <p>Confirmar que o kit foi trocado hoje?</p>
      <textarea id="exchange-notes" placeholder="Observa√ß√µes..." style="width: 100%; margin: 15px 0; padding: 10px;"></textarea>
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-secondary" id="close-exchange">Cancelar</button>
        <button class="btn btn-primary" id="confirm-exchange">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { authManager } from '../js/auth.js';
    import { dbManager } from '../js/database.js';
    import { getDatabase, ref, get, update, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    authManager.requireAuth();

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');

    async function init() {
        const uid = await dbManager._waitForUser();
        const db = getDatabase();
        const mRef = ref(db, `users/${uid}/manicures/${id}`);

        // Carregar Dados
        const snap = await get(mRef);
        if (snap.exists()) {
            const data = snap.val();
            renderData(data);
            loadHistory(uid);
        }
    }

    function renderData(data) {
        document.getElementById('det-name').textContent = data.name;
        document.getElementById('det-phone').textContent = data.phone;
        document.getElementById('det-address').textContent = data.address || 'N√£o informado';
        document.getElementById('det-plan').textContent = data.planType;
        
        const isAc = data.status === 'active';
        document.getElementById('det-status-badge').className = `badge ${isAc ? 'badge-success' : 'badge-secondary'}`;
        document.getElementById('det-status-badge').textContent = isAc ? 'ATIVA' : 'INATIVA';
        document.getElementById('toggle-ui').classList.toggle('active', isAc);
        document.getElementById('status-text').textContent = isAc ? 'Ativa' : 'Inativa';
    }

    async function loadHistory(uid) {
        const db = getDatabase();
        const hRef = ref(db, `users/${uid}/exchanges/${id}`);
        const snap = await get(hRef);
        if (snap.exists()) {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            Object.values(snap.val()).reverse().forEach(ex => {
                list.innerHTML += `<div class="history-item">üìÖ ${new Date(ex.date).toLocaleDateString()} - ${ex.notes || 'Sem observa√ß√µes'}</div>`;
            });
        }
    }

    // Evento Registrar Troca
    document.getElementById('confirm-exchange').onclick = async () => {
        const uid = await dbManager._waitForUser();
        const db = getDatabase();
        const notes = document.getElementById('exchange-notes').value;
        
        const newExRef = push(ref(db, `users/${uid}/exchanges/${id}`));
        await set(newExRef, { date: Date.now(), notes: notes });
        
        alert("Troca registrada!");
        location.reload();
    };

    // Abre/Fecha Modal
    document.getElementById('open-exchange').onclick = () => document.getElementById('modal-exchange').classList.add('show');
    document.getElementById('close-exchange').onclick = () => document.getElementById('modal-exchange').classList.remove('show');

    init();
  </script>
</body>
</html>
