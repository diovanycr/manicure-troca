<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes da Manicure - Gest√£o de Manicures</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" href="data:,">
  <style>
    .container-page { max-width: 900px; margin: 0 auto; padding: 2rem; }
    .header-card { background: white; padding: 2rem; border-radius: 1rem; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
    .card { background: white; border-radius: 0.75rem; border: 1px solid #e2e8f0; }
    .card-header { padding: 1.5rem; border-bottom: 1px solid #e2e8f0; font-weight: bold; background: #f8fafc; }
    .card-body { padding: 1.5rem; }
    
    /* Toggle Switch */
    .status-toggle { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f1f5f9; border-radius: 0.5rem; cursor: pointer; margin-top: 1rem; }
    .toggle-switch { width: 46px; height: 24px; background: #cbd5e1; border-radius: 23px; position: relative; transition: 0.3s; }
    .toggle-switch.active { background: #22c55e; }
    .toggle-switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
    .toggle-switch.active::after { left: 24px; }

    /* Modais */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; }
    
    .history-item { padding: 12px; border-bottom: 1px solid #f1f5f9; }
    .history-item:last-child { border: none; }
    .btn-group { display: flex; flex-direction: column; gap: 10px; }
    .text-muted { color: #64748b; font-size: 0.9rem; }
  </style>
</head>
<body>

  <div class="container-page">
    <a href="../index.html" style="text-decoration: none; color: #7c3aed; font-weight: bold; display: inline-block; margin-bottom: 1rem;">‚Üê Voltar para Lista</a>

    <div class="header-card">
      <div class="header-info">
        <h1 id="det-name">Carregando...</h1>
        <p id="det-phone" class="text-muted">--</p>
        <div style="margin-top: 10px;">
            <span id="det-status-badge" class="badge">---</span>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" id="btn-open-exchange">üîÑ Registrar Troca</button>
        <button class="btn btn-secondary" id="btn-open-receipt">üìÇ Enviar Comprovante</button>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">Informa√ß√µes Cadastrais</div>
        <div class="card-body">
          <p><strong>Endere√ßo:</strong> <br><span id="det-address" class="text-muted">--</span></p>
          <p style="margin-top: 1rem;"><strong>Plano Atual:</strong> <span id="det-plan">--</span></p>
          
          <div class="status-toggle" id="btn-toggle-status">
            <span>Status:</span>
            <div class="toggle-switch" id="toggle-ui"></div>
            <span id="status-text">---</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Controle de Trocas</div>
        <div class="card-body">
          <p><strong>√öltima Troca:</strong> <span id="last-date">--/--/----</span></p>
          <p><strong>Pr√≥xima Troca:</strong> <span id="next-date">--/--/----</span></p>
          <hr style="margin: 1rem 0; border: 0; border-top: 1px solid #eee;">
          <p><strong>Dias restantes:</strong> <span id="days-left" style="font-weight: bold; color: #7c3aed;">--</span></p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Hist√≥rico de Trocas</div>
      <div class="card-body" id="history-list">
        <p class="text-muted">Buscando hist√≥rico...</p>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-exchange">
    <div class="modal-content">
      <h2>Registrar Troca de Kit</h2>
      <p class="text-muted">Isso atualizar√° a data da pr√≥xima troca para daqui a 28 dias.</p>
      <textarea id="exchange-notes" placeholder="Observa√ß√µes (opcional)..." style="width: 100%; margin: 15px 0; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit;"></textarea>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" id="btn-close-exchange">Cancelar</button>
        <button class="btn btn-primary" id="btn-confirm-exchange">Confirmar Registro</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-receipt">
    <div class="modal-content">
      <h2>Enviar Comprovante</h2>
      <p class="text-muted">Selecione a imagem do pagamento.</p>
      <input type="file" id="file-input" accept="image/*" style="margin: 20px 0;">
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" id="btn-close-receipt">Cancelar</button>
        <button class="btn btn-primary" id="btn-upload-receipt">Fazer Upload</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { authManager } from '../js/auth.js';
    import { dbManager } from '../js/database.js';
    import { getDatabase, ref, get, update, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // 1. Verifica√ß√£o de Autentica√ß√£o
    authManager.requireAuth();

    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    let selectedFile = null;

    if (!id) window.location.href = '../index.html';

    // 2. Carregamento Inicial
    async function init() {
        try {
            const uid = await dbManager._waitForUser();
            const db = getDatabase();
            const mRef = ref(db, `users/${uid}/manicures/${id}`);

            const snap = await get(mRef);
            if (snap.exists()) {
                const data = snap.val();
                renderUI(data);
                loadExchanges(uid);
            } else {
                alert("Manicure n√£o encontrada!");
                window.location.href = '../index.html';
            }
        } catch (err) {
            console.error("Erro ao iniciar:", err);
        }
    }

    function renderUI(data) {
        document.getElementById('det-name').textContent = data.name;
        document.getElementById('det-phone').textContent = data.phone;
        document.getElementById('det-address').textContent = data.address || 'Endere√ßo n√£o cadastrado';
        document.getElementById('det-plan').textContent = "Plano " + data.planType;
        
        const isActive = data.status === 'active';
        const badge = document.getElementById('det-status-badge');
        badge.textContent = isActive ? 'ATIVA' : 'INATIVA';
        badge.className = `badge ${isActive ? 'badge-success' : 'badge-secondary'}`;
        
        document.getElementById('toggle-ui').classList.toggle('active', isActive);
        document.getElementById('status-text').textContent = isActive ? 'Ativa' : 'Inativa';

        // Datas
        if(data.lastExchangeDate) {
            document.getElementById('last-date').textContent = new Date(data.lastExchangeDate).toLocaleDateString();
        }
        if(data.nextExchangeDate) {
            const next = new Date(data.nextExchangeDate);
            document.getElementById('next-date').textContent = next.toLocaleDateString();
            
            const diff = Math.ceil((next - new Date()) / (1000 * 60 * 60 * 24));
            document.getElementById('days-left').textContent = diff > 0 ? diff + " dias" : "Troca Atrasada!";
        }
    }

    async function loadExchanges(uid) {
        const db = getDatabase();
        const hRef = ref(db, `users/${uid}/exchanges/${id}`);
        const snap = await get(hRef);
        const list = document.getElementById('history-list');
        
        if (snap.exists()) {
            list.innerHTML = '';
            Object.values(snap.val()).reverse().forEach(ex => {
                const date = new Date(ex.date).toLocaleDateString();
                list.innerHTML += `
                    <div class="history-item">
                        <strong>üìÖ ${date}</strong> - ${ex.notes || 'Sem observa√ß√µes'}
                    </div>`;
            });
        } else {
            list.innerHTML = '<p class="text-muted">Nenhuma troca registrada.</p>';
        }
    }

    // 3. Eventos de Clique (Modais e A√ß√µes)
    document.getElementById('btn-open-exchange').onclick = () => document.getElementById('modal-exchange').classList.add('show');
    document.getElementById('btn-close-exchange').onclick = () => document.getElementById('modal-exchange').classList.remove('show');
    
    document.getElementById('btn-open-receipt').onclick = () => document.getElementById('modal-receipt').classList.add('show');
    document.getElementById('btn-close-receipt').onclick = () => document.getElementById('modal-receipt').classList.remove('show');

    // Registrar Troca
    document.getElementById('btn-confirm-exchange').onclick = async () => {
        const btn = document.getElementById('btn-confirm-exchange');
        btn.disabled = true;
        btn.textContent = "Salvando...";
        
        try {
            const uid = await dbManager._waitForUser();
            const db = getDatabase();
            const notes = document.getElementById('exchange-notes').value;
            const now = Date.now();
            const next = now + (28 * 24 * 60 * 60 * 1000); // +28 dias

            // Salva no hist√≥rico
            const historyRef = push(ref(db, `users/${uid}/exchanges/${id}`));
            await set(historyRef, { date: now, notes: notes });

            // Atualiza datas na manicure
            await update(ref(db, `users/${uid}/manicures/${id}`), {
                lastExchangeDate: now,
                nextExchangeDate: next
            });

            location.reload();
        } catch (err) {
            alert("Erro ao salvar troca");
            btn.disabled = false;
        }
    };

    // Mudar Status (Ativa/Inativa)
    document.getElementById('btn-toggle-status').onclick = async () => {
        const uid = await dbManager._waitForUser();
        const db = getDatabase();
        const currentActive = document.getElementById('toggle-ui').classList.contains('active');
        const newStatus = currentActive ? 'inactive' : 'active';

        await update(ref(db, `users/${uid}/manicures/${id}`), { status: newStatus });
        location.reload();
    };

    // Iniciar
    init();
  </script>
</body>
</html>
