<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Gestão de Manicures</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Estilos base para garantir que o layout funcione mesmo se o CSS externo falhar */
    body { margin: 0; font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    
    .sidebar {
      position: fixed; left: 0; top: 0; width: 250px; height: 100vh;
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      color: white; padding: 2rem 1rem; z-index: 100;
    }

    .sidebar-header {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;
      padding-bottom: 2rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-logo {
      width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem; display: flex; align-items: center; justify-content: center;
    }

    .nav-menu { list-style: none; padding: 0; }
    .nav-item { margin-bottom: 0.5rem; }
    .nav-link {
      display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
      color: rgba(255, 255, 255, 0.8); text-decoration: none; border-radius: 0.5rem; transition: 0.2s;
    }
    .nav-link.active, .nav-link:hover { background: rgba(255, 255, 255, 0.1); color: white; }

    .main-content { margin-left: 250px; padding: 2.5rem; min-height: 100vh; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    
    .stat-card { background: white; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .stat-card-header { display: flex; justify-content: space-between; color: #64748b; font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; }
    .stat-card-value { font-size: 1.875rem; font-weight: 700; color: #1e293b; }
    .stat-card-desc { font-size: 0.75rem; color: #94a3b8; margin-top: 0.5rem; }

    .content-section { background: white; border-radius: 0.75rem; border: 1px solid #e2e8f0; margin-bottom: 2rem; overflow: hidden; }
    .section-header { padding: 1.5rem; border-bottom: 1px solid #f1f5f9; }
    .section-header h2 { margin: 0; font-size: 1.125rem; color: #1e293b; }
    
    .manicure-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1.25rem 1.5rem; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s;
    }
    .manicure-item:hover { background: #f8fafc; }
    .manicure-item:last-child { border-bottom: none; }

    .badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-secondary { background: #f1f5f9; color: #475569; }

    .btn-primary {
      display: inline-flex; align-items: center; gap: 8px; background: #7c3aed; color: white;
      border: none; padding: 0.75rem 1.25rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600;
    }

    .sidebar-footer { position: absolute; bottom: 1.5rem; left: 1rem; right: 1rem; }
  </style>
</head>
<body>

  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
      </div>
      <div class="sidebar-title">
        <h2 style="font-size: 1.1rem; margin: 0;">Gestão Manicures</h2>
        <p style="font-size: 0.75rem; opacity: 0.8; margin: 0;">Controle de Kits</p>
      </div>
    </div>

    <nav>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="index.html" class="nav-link active">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="pages/manicures.html" class="nav-link">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
            <span>Manicures</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="pages/alerts.html" class="nav-link">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <span>Alertas</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <div id="user-info" style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;"></div>
      <button class="btn-primary" style="width: 100%; background: rgba(255,255,255,0.1);" id="logout-btn">Sair</button>
    </div>
  </aside>

  <main class="main-content">
    <div class="header">
      <div>
        <h1 style="margin: 0; color: #1e293b;">Dashboard</h1>
        <p style="color: #64748b; margin: 0.25rem 0 0;">Visão geral do controle de trocas.</p>
      </div>
      <button class="btn-primary" onclick="window.location.href='pages/new-manicure.html'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Nova Manicure
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-header">Total Manicures</div>
        <div class="stat-card-value" id="total-manicures">0</div>
        <div class="stat-card-desc" id="total-desc">0 ativas / 0 inativas</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-header">Alertas de Troca</div>
        <div class="stat-card-value" id="alerts-count" style="color: #f59e0b;">0</div>
        <div class="stat-card-desc">Para os próximos 2 dias</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-header">Kits em Uso</div>
        <div class="stat-card-value" id="active-plans" style="color: #3b82f6;">0</div>
        <div class="stat-card-desc">Baseado em profissionais ativas</div>
      </div>
    </div>

    <div id="alerts-section" class="content-section" style="display: none; border-color: #fecaca;">
      <div class="section-header" style="background: #fff1f2;">
        <h2 style="color: #991b1b;">⚠️ Atenção: Trocas Urgentes</h2>
      </div>
      <div id="alerts-list"></div>
    </div>

    <div class="content-section">
      <div class="section-header">
        <h2>Manicures Recentes</h2>
      </div>
      <div id="recent-manicures">
        <p style="padding: 2rem; text-align: center; color: #94a3b8;">Carregando dados...</p>
      </div>
    </div>
  </main>

  <script src="js/utils.js"></script>
  <script type="module">
    import { authManager } from './js/auth.js';
    import { dbManager } from './js/database.js';

    authManager.requireAuth();
    document.getElementById('logout-btn').onclick = () => authManager.signOut();

    async function loadDashboard() {
      try {
        const manicures = await dbManager.getAllManicures();
        
        // Cálculos
        const active = manicures.filter(m => m.status === 'active');
        const inactive = manicures.filter(m => m.status === 'inactive');
        
        // Simulação de alertas (Lógica baseada em data)
        const alerts = manicures.filter(m => {
          if(!m.nextExchangeDate) return false;
          const today = new Date();
          const nextDate = new Date(m.nextExchangeDate);
          const diffTime = nextDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return diffDays <= 2 && m.status === 'active';
        });

        // Preencher stats
        document.getElementById('total-manicures').textContent = manicures.length;
        document.getElementById('total-desc').textContent = `${active.length} ativas / ${inactive.length} inativas`;
        document.getElementById('alerts-count').textContent = alerts.length;
        document.getElementById('active-plans').textContent = active.length;

        // Renderizar Alertas
        if (alerts.length > 0) {
          document.getElementById('alerts-section').style.display = 'block';
          document.getElementById('alerts-list').innerHTML = alerts.map(m => `
            <div class="manicure-item" onclick="window.location.href='pages/manicure-details.html?id=${m.id}'">
              <div>
                <h3 style="margin:0; font-size: 1rem;">${m.name}</h3>
                <p style="margin:0; font-size: 0.8rem; color: #64748b;">Vence em: ${m.nextExchangeDate}</p>
              </div>
              <span class="badge badge-danger">Trocar Agora</span>
            </div>
          `).join('');
        }

        // Renderizar Recentes (últimas 5)
        const recent = manicures.slice(-5).reverse();
        document.getElementById('recent-manicures').innerHTML = recent.map(m => `
          <div class="manicure-item" onclick="window.location.href='pages/manicure-details.html?id=${m.id}'">
            <div>
              <h3 style="margin:0; font-size: 1rem;">${m.name}</h3>
              <p style="margin:0; font-size: 0.8rem; color: #64748b;">${m.phone}</p>
            </div>
            <span class="badge ${m.status === 'active' ? 'badge-success' : 'badge-secondary'}">
              ${m.status === 'active' ? 'Ativa' : 'Inativa'}
            </span>
          </div>
        `).join('');

      } catch (err) {
        console.error("Erro dashboard:", err);
      }
    }

    window.onload = loadDashboard;
  </script>
</body>
</html>
